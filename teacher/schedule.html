<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekly Schedule</title>
  <link rel="stylesheet" href="assets/css/schedule.css" />
  <style>
    .collapsible-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: none;
      border: 0;
      padding: 0;
      font: inherit;
      color: inherit;
      cursor: pointer;
    }

    .collapsible-icon {
      display: inline-flex;
      justify-content: center;
      width: 1.5rem;
    }

    .class-grid[hidden] {
      display: none;
    }

    .weekday-button {
      display: block;
      width: 100%;
      height: 100%;
      padding: 0;
      border: 0;
      background: transparent;
      font: inherit;
      color: inherit;
      cursor: pointer;
    }

    .weekday-button:focus-visible {
      outline: 2px solid var(--muted);
      outline-offset: 2px;
    }

    .weekday-menu {
      position: fixed;
      z-index: 10;
      min-width: 160px;
      padding: 6px;
      border: 1px solid var(--grid);
      border-radius: 8px;
      background: #ffffff;
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.18);
    }

    .weekday-menu[hidden] {
      display: none;
    }

    .weekday-menu button {
      width: 100%;
      padding: 6px 8px;
      border: 0;
      background: transparent;
      font: inherit;
      text-align: left;
      cursor: pointer;
      color: inherit;
    }

    .weekday-menu button:focus-visible {
      outline: 2px solid var(--muted);
      outline-offset: 2px;
    }

    .view-toggle {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin: 1rem 0 0;
    }

    .view-toggle button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.75rem;
      border: 1px solid var(--grid);
      border-radius: 999px;
      background: #ffffff;
      font: inherit;
      cursor: pointer;
    }

    .view-toggle button[aria-checked="true"] {
      background: var(--cool-1, #e2f4ff);
    }

    .view-toggle button:focus-visible {
      outline: 2px solid var(--muted);
      outline-offset: 2px;
    }

    .view-toggle-indicator {
      display: inline-flex;
      width: 2rem;
      height: 1rem;
      border-radius: 999px;
      background: var(--grid);
      position: relative;
      flex-shrink: 0;
    }

    .view-toggle-indicator::after {
      content: "";
      position: absolute;
      top: 2px;
      left: 2px;
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.2);
      transition: transform 0.2s ease;
    }

    .view-toggle button[aria-checked="true"] .view-toggle-indicator::after {
      transform: translateX(1rem);
    }

    .schedule-table-wrap {
      position: relative;
      --today-highlight-base: rgba(59, 130, 246, 0.35);
    }

    .today-highlighted {
      background-color: var(--today-highlight-fill);
    }

    .current-time-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .current-time-line {
      position: absolute;
      height: 2px;
      background: rgba(239, 68, 68, 0.8);
      box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.3);
    }

    .current-time-label {
      position: absolute;
      top: 50%;
      right: 100%;
      transform: translate(-0.4rem, -50%);
      padding: 0 0.4rem;
      font-size: 0.7rem;
      line-height: 1.2;
      border-radius: 999px;
      background: rgba(239, 68, 68, 0.12);
      color: #991b1b;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <main>
    <section class="class-pages" aria-label="Class pages">
      <h2>
        <button class="collapsible-toggle" type="button" aria-expanded="false" aria-controls="class-pages-panel">
          <span>Class Pages</span>
          <span class="collapsible-icon" aria-hidden="true">+</span>
        </button>
      </h2>
      <div class="class-grid" id="class-pages-panel" hidden>
        <a class="class-card" href="pages/10A.html" aria-label="Open schedule page for class 10A">
          <span class="class-icon warm-2">10A</span>
        </a>
        <a class="class-card" href="pages/10B.html" aria-label="Open schedule page for class 10B">
          <span class="class-icon warm">10B</span>
        </a>
        <a class="class-card" href="pages/10C.html" aria-label="Open schedule page for class 10C">
          <span class="class-icon warm">10C</span>
        </a>
        <a class="class-card" href="pages/10D.html" aria-label="Open schedule page for class 10D">
          <span class="class-icon warm">10D</span>
        </a>
        <a class="class-card" href="pages/10E.html" aria-label="Open schedule page for class 10E">
          <span class="class-icon warm">10E</span>
        </a>
        <a class="class-card" href="pages/11A.html" aria-label="Open schedule page for class 11A">
          <span class="class-icon cool-2">11A</span>
        </a>
        <a class="class-card" href="pages/11B.html" aria-label="Open schedule page for class 11B">
          <span class="class-icon cool">11B</span>
        </a>
        <a class="class-card" href="pages/11C.html" aria-label="Open schedule page for class 11C">
          <span class="class-icon cool">11C</span>
        </a>
        <a class="class-card" href="pages/11D.html" aria-label="Open schedule page for class 11D">
          <span class="class-icon cool">11D</span>
        </a>
        <a class="class-card" href="pages/11E.html" aria-label="Open schedule page for class 11E">
          <span class="class-icon cool">11E</span>
        </a>
      </div>
    </section>

    <section class="table-wrap" aria-label="Weekly schedule table">
      <div class="schedule-table-wrap">
        <table>
        <thead>
          <tr id="weekday-header">
            <th scope="col" aria-hidden="true"></th>
            <th scope="col">
              <button class="weekday-button" type="button" data-column="0" aria-controls="weekday-menu" aria-expanded="false">
                Monday
              </button>
            </th>
            <th scope="col">
              <button class="weekday-button" type="button" data-column="1" aria-controls="weekday-menu" aria-expanded="false">
                Tuesday
              </button>
            </th>
            <th scope="col">
              <button class="weekday-button" type="button" data-column="2" aria-controls="weekday-menu" aria-expanded="false">
                Wednesday
              </button>
            </th>
            <th scope="col">
              <button class="weekday-button" type="button" data-column="3" aria-controls="weekday-menu" aria-expanded="false">
                Thursday
              </button>
            </th>
            <th scope="col">
              <button class="weekday-button" type="button" data-column="4" aria-controls="weekday-menu" aria-expanded="false">
                Friday
              </button>
            </th>
          </tr>
          <tr>
            <th scope="col">Time</th>
            <th scope="col">Day 1</th>
            <th scope="col">Day 2</th>
            <th scope="col">Day 3</th>
            <th scope="col">Day 4</th>
            <th scope="col">Day 5</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <th scope="row">07:05 - 07:55</th>
            <td>
              <a class="class-link" href="pages/10B.html" aria-label="Open schedule page for class 10B">
                <span class="block warm">10B-1</span>
              </a>
            </td>
            <td class="empty">—</td>
            <td>
              <a class="class-link" href="pages/11E.html" aria-label="Open schedule page for class 11E">
                <span class="block cool">11E-2</span>
              </a>
            </td>
            <td>
              <a class="class-link" href="pages/10D.html" aria-label="Open schedule page for class 10D">
                <span class="block warm">10D-2</span>
              </a>
            </td>
            <td class="empty">—</td>
          </tr>

          <tr>
            <th scope="row">07:55 - 08:45</th>
            <td class="empty">—</td>
            <td class="empty">—</td>
            <td>
              <a class="class-link" href="pages/10A.html" aria-label="Open schedule page for class 10A">
                <span class="block warm-2">10A-2</span>
              </a>
            </td>
            <td class="empty">—</td>
            <td>
              <a class="class-link" href="pages/10C.html" aria-label="Open schedule page for class 10C">
                <span class="block warm">10C-2</span>
              </a>
            </td>
          </tr>

          <tr>
            <th scope="row">08:45 - 09:35</th>
            <td>
              <a class="class-link" href="pages/10A.html" aria-label="Open schedule page for class 10A">
                <span class="block warm-2">10A-1</span>
              </a>
            </td>
            <td class="empty">—</td>
            <td>
              <a class="class-link" href="pages/11A.html" aria-label="Open schedule page for class 11A">
                <span class="block cool-2">11A-2</span>
              </a>
            </td>
            <td class="empty">—</td>
            <td>
              <a class="class-link" href="pages/11B.html" aria-label="Open schedule page for class 11B">
                <span class="block cool">11B-2</span>
              </a>
            </td>
          </tr>

          <tr class="row-activity">
            <th scope="row">09:35 - 10:05</th>
            <td class="empty">—</td>
            <td class="bar activity">Rodaderos</td>
            <td class="empty">—</td>
            <td class="bar activity">Kilomb</td>
            <td class="empty">—</td>
          </tr>

          <tr>
            <th scope="row">10:05 - 11:00</th>
            <td class="empty">—</td>
            <td>
              <a class="class-link" href="pages/11E.html" aria-label="Open schedule page for class 11E">
                <span class="block cool">11E-1</span>
              </a>
            </td>
            <td class="empty">—</td>
            <td class="empty">—</td>
            <td class="empty">—</td>
          </tr>

          <tr>
            <th scope="row">11:00 - 11:55</th>
            <td>
              <a class="class-link" href="pages/11A.html" aria-label="Open schedule page for class 11A">
                <span class="block cool-2">11A-1</span>
              </a>
            </td>
            <td class="empty">—</td>
            <td>
              <a class="class-link" href="pages/10D.html" aria-label="Open schedule page for class 10D">
                <span class="block warm">10D-1</span>
              </a>
            </td>
            <td>
              <a class="class-link" href="pages/10E.html" aria-label="Open schedule page for class 10E">
                <span class="block warm">10E-2</span>
              </a>
            </td>
            <td class="empty">—</td>
          </tr>

          <tr>
            <th scope="row">11:55 - 12:50</th>
            <td>
              <a class="class-link" href="pages/11D.html" aria-label="Open schedule page for class 11D">
                <span class="block cool">11D-1</span>
              </a>
            </td>
            <td class="empty">—</td>
            <td>
              <a class="class-link" href="pages/10E.html" aria-label="Open schedule page for class 10E">
                <span class="block warm">10E-1</span>
              </a>
            </td>
            <td>
              <a class="class-link" href="pages/11D.html" aria-label="Open schedule page for class 11D">
                <span class="block cool">11D-2</span>
              </a>
            </td>
            <td>
              <a class="class-link" href="pages/10B.html" aria-label="Open schedule page for class 10B">
                <span class="block warm">10B-2</span>
              </a>
            </td>
          </tr>

          <tr class="row-activity">
            <th scope="row">12:50 - 13:50</th>
            <td class="empty">—</td>
            <td class="empty">—</td>
            <td class="empty">—</td>
            <td class="empty">—</td>
            <td class="bar activity">Kilomb</td>
          </tr>

          <tr>
            <th scope="row">13:50 - 14:45</th>
            <td>
              <a class="class-link" href="pages/10C.html" aria-label="Open schedule page for class 10C">
                <span class="block warm">10C-1</span>
              </a>
            </td>
            <td>
              <a class="class-link" href="pages/11C.html" aria-label="Open schedule page for class 11C">
                <span class="block cool">11C-1</span>
              </a>
            </td>
            <td>
              <a class="class-link" href="pages/11B.html" aria-label="Open schedule page for class 11B">
                <span class="block cool">11B-1</span>
              </a>
            </td>
            <td>
              <a class="class-link" href="pages/11C.html" aria-label="Open schedule page for class 11C">
                <span class="block cool">11C-2</span>
              </a>
            </td>
            <td class="empty">—</td>
          </tr>

          <tr class="row-pause">
            <th scope="row">14:45 - 15:00</th>
            <td class="empty">—</td>
            <td class="empty">—</td>
            <td class="bar pause">Pause</td>
            <td class="empty">—</td>
            <td class="empty">—</td>
          </tr>

          <tr>
            <th scope="row">15:00 - 14:00</th>
            <td class="empty">—</td>
            <td class="empty">—</td>
            <td class="empty">—</td>
            <td class="empty">—</td>
            <td class="empty">—</td>
          </tr>
        </tbody>
        </table>
        <div class="current-time-overlay" aria-hidden="true" hidden>
          <div class="current-time-line">
            <span class="current-time-label"></span>
          </div>
        </div>
      </div>
      <div class="view-toggle">
        <span id="weekday-view-label">Weekday view</span>
        <button id="weekday-view-toggle" type="button" role="switch" aria-checked="false" aria-labelledby="weekday-view-label">
          <span class="view-toggle-indicator" aria-hidden="true"></span>
          <span class="view-toggle-text" aria-hidden="true">Off</span>
        </button>
      </div>
    </section>
  </main>
  <div class="weekday-menu" id="weekday-menu" role="menu" aria-hidden="true" hidden>
    <button type="button" role="menuitem" data-weekday="Monday">Monday</button>
    <button type="button" role="menuitem" data-weekday="Tuesday">Tuesday</button>
    <button type="button" role="menuitem" data-weekday="Wednesday">Wednesday</button>
    <button type="button" role="menuitem" data-weekday="Thursday">Thursday</button>
    <button type="button" role="menuitem" data-weekday="Friday">Friday</button>
  </div>
  <script>
    const toggle = document.querySelector(".collapsible-toggle");
    const panel = document.getElementById("class-pages-panel");
    const icon = toggle?.querySelector(".collapsible-icon");

    if (toggle && panel && icon) {
      toggle.addEventListener("click", () => {
        const isExpanded = toggle.getAttribute("aria-expanded") === "true";
        toggle.setAttribute("aria-expanded", String(!isExpanded));
        panel.hidden = isExpanded;
        icon.textContent = isExpanded ? "+" : "−";
      });
    }

    const weekdays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
    const storageKey = "scheduleDay1Weekday";
    const weekdayViewKey = "scheduleWeekdayView";
    const weekdayHeader = document.getElementById("weekday-header");
    const weekdayButtons = Array.from(document.querySelectorAll(".weekday-button"));
    const weekdayMenu = document.getElementById("weekday-menu");
    const weekdayMenuItems = weekdayMenu ? Array.from(weekdayMenu.querySelectorAll("button[data-weekday]")) : [];
    const weekdayViewToggle = document.getElementById("weekday-view-toggle");
    const weekdayViewIndicator = weekdayViewToggle?.querySelector(".view-toggle-text");
    const scheduleTable = document.querySelector(".table-wrap table");
    const scheduleWrap = document.querySelector(".schedule-table-wrap");
    const currentTimeOverlay = document.querySelector(".current-time-overlay");
    const currentTimeLine = document.querySelector(".current-time-line");
    const currentTimeLabel = document.querySelector(".current-time-label");
    const originalBackgrounds = new Map();
    let lastTrigger = null;
    let isWeekdayView = false;

    const setExpandedState = (isExpanded) => {
      weekdayButtons.forEach((button) => {
        button.setAttribute("aria-expanded", String(isExpanded));
      });
    };

    const updateWeekdayLabels = (day1Label) => {
      const offset = Math.max(0, weekdays.indexOf(day1Label));
      weekdayButtons.forEach((button, index) => {
        const label = weekdays[(offset + index) % weekdays.length];
        button.textContent = label;
      });
    };

    const storeWeekday = (day1Label) => {
      try {
        localStorage.setItem(storageKey, day1Label);
      } catch (error) {
        console.error("Unable to store weekday selection.", error);
      }
    };

    const getStoredWeekday = () => {
      try {
        return localStorage.getItem(storageKey);
      } catch (error) {
        console.error("Unable to read weekday selection.", error);
        return null;
      }
    };

    const applyWeekdaySelection = (day1Label) => {
      if (!weekdays.includes(day1Label)) {
        return;
      }
      updateWeekdayLabels(day1Label);
      storeWeekday(day1Label);
      if (isWeekdayView) {
        applyColumnOrder("weekday");
      }
      updateTodayColumnHighlight();
    };

    const positionMenu = () => {
      if (!weekdayMenu || !weekdayHeader) {
        return;
      }
      const rect = weekdayHeader.getBoundingClientRect();
      const top = rect.bottom + 4;
      const left = rect.left;
      weekdayMenu.style.top = `${top}px`;
      weekdayMenu.style.left = `${left}px`;
    };

    const openMenu = (trigger) => {
      if (!weekdayMenu) {
        return;
      }
      lastTrigger = trigger || document.activeElement;
      positionMenu();
      weekdayMenu.hidden = false;
      weekdayMenu.setAttribute("aria-hidden", "false");
      setExpandedState(true);
      const firstItem = weekdayMenuItems[0];
      if (firstItem) {
        firstItem.focus();
      }
    };

    const closeMenu = () => {
      if (!weekdayMenu) {
        return;
      }
      weekdayMenu.hidden = true;
      weekdayMenu.setAttribute("aria-hidden", "true");
      setExpandedState(false);
      if (lastTrigger && typeof lastTrigger.focus === "function") {
        lastTrigger.focus();
      }
    };

    if (weekdayHeader && weekdayMenu) {
      weekdayHeader.addEventListener("click", (event) => {
        const targetButton = event.target.closest(".weekday-button");
        if (targetButton) {
          openMenu(targetButton);
          return;
        }
        openMenu(weekdayButtons[0]);
      });

      weekdayButtons.forEach((button) => {
        button.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            closeMenu();
          }
        });
      });

      weekdayMenuItems.forEach((item) => {
        item.addEventListener("click", () => {
          const selection = item.getAttribute("data-weekday");
          if (selection) {
            applyWeekdaySelection(selection);
          }
          closeMenu();
        });
      });

      weekdayMenu.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          event.preventDefault();
          closeMenu();
        }
      });

      document.addEventListener("click", (event) => {
        if (!weekdayMenu.hidden) {
          const target = event.target;
          if (!weekdayMenu.contains(target) && !weekdayHeader.contains(target)) {
            closeMenu();
          }
        }
      });

      window.addEventListener("resize", () => {
        if (!weekdayMenu.hidden) {
          positionMenu();
        }
      });
    }

    const initialWeekday = getStoredWeekday();
    if (initialWeekday && weekdays.includes(initialWeekday)) {
      updateWeekdayLabels(initialWeekday);
    } else {
      updateWeekdayLabels(weekdays[0]);
    }

    const ensureDayColumnAttributes = () => {
      if (!scheduleTable) {
        return;
      }
      const rows = scheduleTable.querySelectorAll("tr");
      rows.forEach((row) => {
        const cells = Array.from(row.children);
        cells.slice(1).forEach((cell, index) => {
          if (!cell.hasAttribute("data-day-column")) {
            cell.setAttribute("data-day-column", String(index));
          }
        });
      });
    };

    const getWeekdayOrder = () => {
      const orderMap = new Map();
      weekdayButtons.forEach((button, index) => {
        const label = button.textContent?.trim();
        if (label) {
          orderMap.set(label, index);
        }
      });
      const ordered = weekdays.map((label) => orderMap.get(label));
      if (ordered.some((value) => typeof value !== "number")) {
        return [0, 1, 2, 3, 4];
      }
      return ordered;
    };

    const reorderRow = (row, order) => {
      const cells = Array.from(row.children);
      const timeCell = cells[0];
      if (!timeCell) {
        return;
      }
      const dayCells = cells.slice(1);
      const cellMap = new Map();
      dayCells.forEach((cell) => {
        const index = Number(cell.getAttribute("data-day-column"));
        if (!Number.isNaN(index)) {
          cellMap.set(index, cell);
        }
      });
      const fragment = document.createDocumentFragment();
      fragment.appendChild(timeCell);
      order.forEach((index) => {
        const cell = cellMap.get(index);
        if (cell) {
          fragment.appendChild(cell);
        }
      });
      row.appendChild(fragment);
    };

    const applyColumnOrder = (mode) => {
      if (!scheduleTable) {
        return;
      }
      const order = mode === "weekday" ? getWeekdayOrder() : [0, 1, 2, 3, 4];
      const rows = scheduleTable.querySelectorAll("tr");
      rows.forEach((row) => reorderRow(row, order));
    };

    const setToggleState = (enabled) => {
      if (!weekdayViewToggle || !weekdayViewIndicator) {
        return;
      }
      isWeekdayView = enabled;
      weekdayViewToggle.setAttribute("aria-checked", String(enabled));
      weekdayViewIndicator.textContent = enabled ? "On" : "Off";
      applyColumnOrder(enabled ? "weekday" : "day");
      updateTodayColumnHighlight();
      updateCurrentTimeLine();
      try {
        localStorage.setItem(weekdayViewKey, String(enabled));
      } catch (error) {
        console.error("Unable to store weekday view selection.", error);
      }
    };

    const getStoredView = () => {
      try {
        return localStorage.getItem(weekdayViewKey);
      } catch (error) {
        console.error("Unable to read weekday view selection.", error);
        return null;
      }
    };

    ensureDayColumnAttributes();
    const storedView = getStoredView();
    setToggleState(storedView === "true");

    if (weekdayViewToggle) {
      weekdayViewToggle.addEventListener("click", () => {
        setToggleState(!isWeekdayView);
      });

      weekdayViewToggle.addEventListener("keydown", (event) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          setToggleState(!isWeekdayView);
        }
      });
    }

    function clearTodayColumnHighlight() {
      if (!scheduleTable) {
        return;
      }
      scheduleTable.querySelectorAll(".today-highlighted").forEach((cell) => {
        const stored = originalBackgrounds.get(cell);
        if (stored) {
          if (stored.background) {
            cell.style.background = stored.background;
          } else {
            cell.style.removeProperty("background");
          }
          if (stored.backgroundColor) {
            cell.style.backgroundColor = stored.backgroundColor;
          } else {
            cell.style.removeProperty("background-color");
          }
          originalBackgrounds.delete(cell);
        } else {
          cell.style.removeProperty("background");
          cell.style.removeProperty("background-color");
        }
        cell.style.removeProperty("--today-highlight-fill");
        cell.classList.remove("today-highlighted");
      });
    }

    function extractColor(value) {
      if (!value) {
        return null;
      }
      const match = value.match(/rgba?\([^)]+\)|#[0-9a-fA-F]{3,8}/);
      return match ? match[0] : null;
    }

    function parseColor(color) {
      if (!color) {
        return null;
      }
      const rgbMatch = color.match(/rgba?\(([^)]+)\)/);
      if (rgbMatch) {
        const parts = rgbMatch[1].match(/[\d.]+/g)?.map(Number) ?? [];
        if (parts.length >= 3) {
          return {
            r: parts[0],
            g: parts[1],
            b: parts[2],
            a: parts.length > 3 ? parts[3] : 1,
          };
        }
      }
      const hexMatch = color.match(/#([0-9a-fA-F]{3,8})/);
      if (hexMatch) {
        const hex = hexMatch[1];
        const expand = (value) => value.split("").map((char) => char + char).join("");
        const normalized = hex.length === 3 || hex.length === 4 ? expand(hex) : hex;
        const hasAlpha = normalized.length === 8;
        const int = parseInt(normalized, 16);
        const r = (int >> (hasAlpha ? 24 : 16)) & 255;
        const g = (int >> (hasAlpha ? 16 : 8)) & 255;
        const b = (int >> (hasAlpha ? 8 : 0)) & 255;
        const a = hasAlpha ? (int & 255) / 255 : 1;
        return { r, g, b, a };
      }
      return null;
    }

    function lightenColor(color, amount = 0.35) {
      const parsed = parseColor(color);
      if (!parsed) {
        return null;
      }
      const blend = (value) => Math.round(value + (255 - value) * amount);
      return `rgba(${blend(parsed.r)}, ${blend(parsed.g)}, ${blend(parsed.b)}, ${parsed.a})`;
    }

    function resolveTodayHighlightBaseColor() {
      if (scheduleWrap) {
        const base = getComputedStyle(scheduleWrap).getPropertyValue("--today-highlight-base").trim();
        if (base) {
          return base;
        }
      }
      const sampleCell = scheduleTable?.querySelector("td, th");
      if (!sampleCell) {
        return null;
      }
      const styles = getComputedStyle(sampleCell);
      return (
        extractColor(styles.boxShadow) ||
        extractColor(styles.outlineColor) ||
        extractColor(styles.borderColor)
      );
    }

    function getTodayWeekdayLabel() {
      const todayIndex = new Date().getDay();
      if (todayIndex === 0 || todayIndex === 6) {
        return null;
      }
      return weekdays[todayIndex - 1];
    }

    function findColumnIndexForWeekday(weekdayLabel) {
      if (!weekdayLabel) {
        return null;
      }
      if (isWeekdayView) {
        const matchingButton = weekdayButtons.find(
          (button) => button.textContent?.trim() === weekdayLabel
        );
        if (matchingButton) {
          const headerCell = matchingButton.closest("[data-day-column]");
          const columnIndex = headerCell?.getAttribute("data-day-column");
          return columnIndex ? Number(columnIndex) : null;
        }
      }
      const dayIndex = weekdayButtons.findIndex(
        (button) => button.textContent?.trim() === weekdayLabel
      );
      return dayIndex >= 0 ? dayIndex : null;
    }

    function updateTodayColumnHighlight() {
      if (!scheduleTable) {
        return;
      }
      const todayLabel = getTodayWeekdayLabel();
      const columnIndex = findColumnIndexForWeekday(todayLabel);
      clearTodayColumnHighlight();
      if (columnIndex === null || Number.isNaN(columnIndex)) {
        return;
      }
      const baseColor = resolveTodayHighlightBaseColor();
      const fillColor = baseColor ? lightenColor(baseColor) : null;
      if (!fillColor) {
        return;
      }
      const highlightOverrides = [
        { start: 9 * 60 + 35, end: 10 * 60 + 5, color: "rgba(44, 149, 62, 0.85)" },
        { start: 12 * 60 + 50, end: 13 * 60 + 50, color: "rgba(44, 149, 62, 0.85)" },
        { start: 14 * 60 + 45, end: 15 * 60 + 0, color: "rgba(116, 101, 173, 0.85)" },
      ];
      scheduleTable
        .querySelectorAll(`[data-day-column="${columnIndex}"]`)
        .forEach((cell) => {
          if (!originalBackgrounds.has(cell)) {
            originalBackgrounds.set(cell, {
              background: cell.style.background,
              backgroundColor: cell.style.backgroundColor,
            });
          }
          const row = cell.closest("tr");
          const timeCell = row?.querySelector("th[scope='row']");
          const range = parseTimeRange(timeCell?.textContent?.trim());
          const override = range
            ? highlightOverrides.find((item) => item.start === range.start && item.end === range.end)
            : null;
          const cellFill = override ? override.color : fillColor;
          cell.style.backgroundColor = cellFill;
          cell.style.setProperty("--today-highlight-fill", cellFill);
          cell.classList.add("today-highlighted");
        });
    }

    function parseTimeRange(text) {
      if (!text) {
        return null;
      }
      const [startText, endText] = text.split("-").map((part) => part.trim());
      const toMinutes = (value) => {
        const [hours, minutes] = value.split(":").map(Number);
        if (Number.isNaN(hours) || Number.isNaN(minutes)) {
          return null;
        }
        return hours * 60 + minutes;
      };
      const start = toMinutes(startText);
      const end = toMinutes(endText);
      if (start === null || end === null || end <= start) {
        return null;
      }
      return { start, end };
    }

    function updateCurrentTimeLine() {
      if (!scheduleTable || !scheduleWrap || !currentTimeOverlay || !currentTimeLine) {
        return;
      }
      const now = new Date();
      const nowMinutes = now.getHours() * 60 + now.getMinutes();
      const rows = Array.from(scheduleTable.querySelectorAll("tbody tr"));
      const matchingRow = rows.find((row) => {
        const timeCell = row.querySelector("th[scope='row']");
        const range = parseTimeRange(timeCell?.textContent?.trim());
        return range ? nowMinutes >= range.start && nowMinutes <= range.end : false;
      });

      if (!matchingRow) {
        currentTimeOverlay.hidden = true;
        return;
      }

      const timeCell = matchingRow.querySelector("th[scope='row']");
      const range = parseTimeRange(timeCell?.textContent?.trim());
      if (!range) {
        currentTimeOverlay.hidden = true;
        return;
      }
      const fraction = (nowMinutes - range.start) / (range.end - range.start);
      const wrapRect = scheduleWrap.getBoundingClientRect();
      const rowRect = matchingRow.getBoundingClientRect();
      const timeCellRect = timeCell?.getBoundingClientRect();
      const leftOffset = timeCellRect ? timeCellRect.right - wrapRect.left : 0;
      const rowTop = rowRect.top - wrapRect.top;
      const top = rowTop + rowRect.height * fraction;
      const width = wrapRect.width - leftOffset;

      currentTimeOverlay.hidden = false;
      currentTimeLine.style.left = `${leftOffset}px`;
      currentTimeLine.style.width = `${width}px`;
      currentTimeLine.style.top = `${top}px`;
      if (currentTimeLabel) {
        currentTimeLabel.textContent = now.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
      }
    }

    updateTodayColumnHighlight();
    updateCurrentTimeLine();
    setInterval(updateCurrentTimeLine, 30000);
    window.addEventListener("resize", updateCurrentTimeLine);
  </script>
</body>
</html>
